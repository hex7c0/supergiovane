"use strict";function bootstrap(a){var b=express();b.set("env",a.env),"production"==a.env?b.enable("view cache"):b.disable("view cache"),b.enable("case sensitive routing"),b.enable("trust proxy"),b.disable("x-powered-by"),a.logger&&b.use(logger(a.logger)),a.timeout&&b.use(require("timeout-request")(a.timeout)),a.signature&&b.use(require("server-signature")(a.signature)),a.sitemap&&require("express-sitemap")(a.sitemap).toFile(),b.use(require("compression")());var c;c=a.cache?function(b,c,e){if(void 0===d[c]){var f,g=0,h=(new Date).getTime();for(var i in d)g++,d[i].time<h&&(f=i,h=d[f].time);g>=a.cache&&(d[f]=void 0),d[c]={content:e,body:b,time:(new Date).getTime()}}}:function(){},http.globalAgent.maxSockets=Math.pow(a.fork,2);var d=Object.create(null),e=resolve(a.dir+"index.min.html");if(b.get("/:pkg/:extra?",function(b,e,f){var g="/",h=b.headers.referer||b.headers.referrer,i=b.params.pkg,j=b.params.extra||"",k=b.query.style?"?style="+b.query.style:"",l=i+j+k;if(a.referer.test(h)===!1&&"badge.svg"!==j)return e.redirect(301,a.referer.source);if(a.cache!==!1&&void 0!==d[l])return e.set("Content-Type",d[l].content),e.status(202).send(d[l].body),void((new Date).getTime()-d[l].time>a.flush&&(d[l]=void 0));if(""!==j)if("badge.svg"===j);else{if(!semver.valid(j))return f(new Error(status[404]));g+=j}return http.get({host:"registry.npmjs.org",path:"/"+i+g,headers:{"User-Agent":VERSION}},function(a){var b=new Buffer(0);return 200!==a.statusCode?f(new Error(status[404])):(a.on("data",function(a){b+=a}),void a.on("end",function(){if(b=JSON.parse(b),b.readme=null,"badge.svg"===j){var a=Object.keys(b.versions).length,d=a>1?"s-":"-";http.get({host:"img.shields.io",path:"/badge/version"+d+a+"-red.svg"+k,agent:!1,headers:{"User-Agent":VERSION}},function(a){var b=new Buffer(0);return 200!==a.statusCode?f(new Error(status[404])):(a.on("data",function(a){b+=a}),void a.on("end",function(){var a="image/svg+xml; charset=utf-8";e.set("Content-Type",a),e.send(b),c(b,l,a)}))}).on("error",function(){return f(new Error(status[404]))})}else{var g="application/json; charset=utf-8";e.set("Content-Type",g),e.send(b),c(b,l,g)}}))}).on("error",function(){return f(new Error(status[404]))})}),b.get("/",function(a,b){return b.sendFile(e)}),b.use(function(b,c,d,e){var f=500,g="";switch(debug("web",{pid:process.pid,error:b.message}),b.message.toLowerCase()){case"not found":return e();default:"production"!==a.env&&(g=b.message.toLowerCase())}d.status(f).json({error:g})}),b.use(function(a,b){var c=404;b.status(c).json({error:status[c].toLowerCase()})}),"test"!=a.env){console.log(process.pid+" | listening on: "+a.host+":"+a.port),debug("start",{pid:process.pid,host:a.host,port:a.port});var f=http.createServer(b);a.timeout&&a.timeout.milliseconds&&(f.timeout=a.timeout.milliseconds),f.listen(a.port,a.host)}return b}try{var cluster=require("cluster"),http=require("http"),resolve=require("path").resolve,status=http.STATUS_CODES,express=require("express"),logger=require("logger-request"),semver=require("semver")}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}var VERSION=JSON.parse(require("fs").readFileSync(__dirname+"/package.json"));VERSION=VERSION.name+"@"+VERSION.version;var debug=function(){};module.exports=function(a){var b=a||Object.create(null),c={env:String(b.env||"production"),host:String(b.host||"127.0.0.1"),port:Number(b.port)||3e3,referer:new RegExp(String(b.referer||"http://127.0.0.1"),"i"),dir:String(b.dir||__dirname+"/public/"),logger:b.logger===!1?!1:b.logger||{},timeout:b.timeout===!1?!1:b.timeout||{},sitemap:b.sitemap===!1?!1:b.sitemap||{},signature:b.signature===!1?!1:b.signature||!1,cache:b.cache===!1?!1:Number(b.cache)||6,flush:Number(b.flush)||864e5,fork:Number(a.fork)<5?require("os").cpus().length:Number(a.fork)||require("os").cpus().length,max:"string"==typeof a.max?a.max:Number(a.max)||0,debug:b.debug===!1?!1:b.debug||"debug.log",task:Boolean(b.task)?b.task:!1};if(c.debug&&(debug=logger({filename:c.debug,standalone:!0,winston:{logger:"_spDebug",level:"debug",json:!1}})),cluster.isMaster){if(c.task&&require("task-manager")(c.task,{output:Boolean(c.debug)}),"production"!=c.env)return bootstrap(c);for(var d=0;d<c.fork;d++)cluster.fork();return void cluster.on("exit",function(a,b,d){a.suicide===!0?cluster.fork():(isNaN(c.max)===!0||c.max-->0)&&cluster.fork(),debug("restart",{pid:a.process.pid,suicide:a.suicide,status:d,code:b,max:c.max})})}return bootstrap(c)};
