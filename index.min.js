"use strict";function bootstrap(a){var b=express();if(b.set("env",a.env),"production"==a.env?b.enable("view cache"):b.disable("view cache"),b.enable("case sensitive routing"),b.enable("trust proxy"),b.disable("x-powered-by"),a.logger&&b.use(logger(a.logger)),a.vhost){var c=require("top-vhost");b.use(c(a.vhost))}if(a.timeout){var d=require("timeout-request");b.use(d(a.timeout))}if(b.use(lusca({xframe:"SAMEORIGIN",xssProtection:!0})),b.use(compression({level:9,threshold:512})),a.signature){var e=require("server-signature");b.use(e(a.signature))}if(a.sitemap){var f=require("express-sitemap");f(a.sitemap).toFile()}var g;g=a.cache?function(b,c,d){if(!h[c]){var e,f=0,g=(new Date).getTime();for(var i in h)f++,h[i].time<g&&(e=i,g=h[e].time);f>=a.cache&&delete h[e],h[c]={content:d,body:b,time:(new Date).getTime()}}}:function(){},http.globalAgent.maxSockets=Math.pow(a.fork,2),http.timeout=6e4;var h=Object.create(null),i=resolve(a.dir+"index.min.html");return b.get("/",function(a,b){b.sendFile(i)}),b.get("/:pkg/:extra?",function(b,c,d){var e="/",f=b.headers.referer||b.headers.referrer,i=b.params.pkg,j=b.params.extra||"",k=b.query.style?"?style="+b.query.style:"",l=i+j+k;if(!a.referer.test(f)&&"badge.svg"!==j)return c.redirect(301,a.referer.source);if(a.cache&&h[l])return c.set("Content-Type",h[l].content),c.status(202).send(h[l].body),void((new Date).getTime()-h[l].time>a.flush&&delete h[l]);if(j)if("badge.svg"===j);else{if(!semver.valid(j))return d(new Error(status[404]));e+=j}http.get({host:"registry.npmjs.org",path:"/"+i+e,headers:{"User-Agent":VERSION}},function(a){var b=new Buffer(0);return 200!==a.statusCode?d(new Error(status[404])):(a.on("data",function(a){b+=a}),void a.on("end",function(){if(b=JSON.parse(b),b.readme=null,"badge.svg"===j){var a=0;for(var e in b.versions)a++;var f=a>1?"s-":"-";http.get({host:"img.shields.io",path:"/badge/version"+f+a+"-red.svg"+k,agent:!1,headers:{"User-Agent":VERSION}},function(a){var b=new Buffer(0);return 200!==a.statusCode?d(new Error(status[404])):(a.on("data",function(a){b+=a}),void a.on("end",function(){var a="image/svg+xml; charset=utf-8";c.set("Content-Type",a),c.send(b),g(b,l,a)}))}).on("error",function(){return d(new Error(status[404]))})}else{var h="application/json; charset=utf-8";c.set("Content-Type",h),c.send(b),g(b,l,h)}}))}).on("error",function(){return d(new Error(status[404]))})}),b.use(function(a,b,c,d){var e=500;switch(debug("web",{pid:process.pid,error:a.message}),a.message.toLowerCase()){case"not found":return void d()}c.set("Content-Type","application/json; charset=utf-8"),c.status(e).send({error:status[e].toLowerCase()})}),b.use(function(a,b){var c=404;b.set("Content-Type","application/json; charset=utf-8"),b.status(c).send({error:status[c].toLowerCase()})}),"test"!=a.env&&(console.log(process.pid+" | listening on: "+a.host+":"+a.port),debug("start",{pid:process.pid,host:a.host,port:a.port}),http.createServer(b).listen(a.port,a.host)),b}try{var cluster=require("cluster"),cpu=2*require("os").cpus().length,http=require("http"),resolve=require("path").resolve,status=http.STATUS_CODES,compression=require("compression"),express=require("express"),logger=require("logger-request"),lusca=require("lusca"),semver=require("semver")}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}var VERSION="supergiovane@1.5.7",debug=function(){};module.exports=function(a){var a=a||Object.create(null),b={env:String(a.env||"production"),host:String(a.host||"127.0.0.1"),port:Number(a.port||3e3),referer:new RegExp(String(a.referer||"http://127.0.0.1"),"i"),dir:String(a.dir||__dirname+"/public/"),logger:0==a.logger?!1:a.logger||Object.create(null),timeout:0==a.timeout?!1:a.timeout||Object.create(null),sitemap:0==a.sitemap?!1:a.sitemap||Object.create(null),vhost:0==a.vhost?!1:a.vhost||!1,signature:0==a.signature?!1:a.signature||!1,cache:0==a.cache?!1:Number(a.cache||6),flush:Number(a.flush||864e5),fork:Number(a.fork||cpu),max:Number(a.max||0),debug:0==a.debug?!1:a.debug||"debug.log",task:Boolean(a.task)?a.task:!1};if(b.debug&&(debug=logger({filename:b.debug,standalone:!0,winston:{logger:"_spDebug",level:"debug"}})),!cluster.isMaster)return bootstrap(b);if(debug("options",b),"production"!=b.env)return bootstrap(b);for(var c=0;c<b.fork;c++)cluster.fork();if(cluster.on("exit",function(a,c,d){console.error(a.process.pid+" died by "+d),debug("restart",{pid:a.process.pid,status:d,code:c,max:b.max}),(0/0===b.max||b.max-->0)&&cluster.fork()}),b.task){var d=require("task-manager");d(b.task,{output:b.debug})}};
