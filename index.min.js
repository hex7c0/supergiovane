/*
 * supergiovane v1.1.0
 * (c) hex7c0 http://supergiovane.tk
 * Licensed under GPLv3
 */
"use strict";function bootstrap(a){var b=express();return b.set("env",a.env),"production"==a.env?b.enable("view cache"):b.disable("view cache"),b.enable("case sensitive routing"),b.enable("strict routing"),b.enable("trust proxy"),b.disable("x-powered-by"),b.disable("etag"),b.use(logger(a.logger)),b.use(timeout(a.timeout)),b.use(lusca({csrf:!1,xframe:"SAMEORIGIN",xssProtection:!0})),b.use(compression({level:9,threshold:256})),sitemap(a.sitemap).toFile(),b.get("/",function(b,c){c.sendfile(a.dir+"index.min.html")}),b.get("/:pkg/",function(b,c){var d=b.headers.referer||b.headers.referrer,e=b.params.pkg;if("string"==typeof e&&a.referer.test(d)){var f=http.request({host:"registry.npmjs.org",port:80,path:"/"+e,method:"GET",headers:{"User-Agent":"supergiovane@"+VERSION,hi_guys:"JSOP_will_be_a_great_feature"}},function(a){var b=new Buffer(0);200==a.statusCode||304==a.statusCode?(a.on("data",function(a){b+=a}),a.on("end",function(){b=b.toString(),b.readme=null,c.end(b)})):c.status(404).end(ERROR)});b.on("error",function(){c.status(404).end(ERROR)}),f.end()}else c.status(404).end(ERROR)}),b.use(function(a,b,c,d){var e=0;switch(a.message.toLowerCase()){case"not found":d();break;case"unauthorized":e=401;break;case"forbidden":e=403;break;case"bad gateway":e=502;break;default:e=500}c.status(e).end(ERROR)}),b.use(function(a,b){var c=404;b.status(c).end(ERROR)}),console.log(process.pid+" | listening on: "+a.host+":"+a.port),http.createServer(b).listen(a.port,a.host),b}var VERSION="1.0.11",ERROR="matusa";try{var cluster=require("cluster"),compression=require("compression"),express=require("express"),sitemap=require("express-sitemap"),http=require("http"),logger=require("logger-request"),lusca=require("lusca"),cpu=require("os").cpus().length,timeout=require("timeout-request")}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}module.exports=function(a){var a=a||Object.create(null),b={env:String(a.env||"production"),host:String(a.host||"127.0.0.1"),port:Number(a.port)||3e3,referer:new RegExp(String(a.referer||"http://127.0.0.1"),"i"),dir:String(a.dir||__dirname+"/public/"),logger:a.logger||Object.create(null),timeout:a.timeout||Object.create(null),sitemap:a.sitemap||Object.create(null)};if("development"==b.env)return bootstrap(b);if(!cluster.isMaster)return bootstrap(b);for(var c=0;cpu>c;c++)cluster.fork();cluster.on("exit",function(a,b,c){console.warn(a.process.pid+" died by "+c)})};
