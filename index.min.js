/*
 * supergiovane v1.3.0
 * (c) hex7c0 http://supergiovane.tk
 * Licensed under GPLv3
 */
"use strict";function bootstrap(a){var b=express();if(b.set("env",a.env),"production"==a.env?b.enable("view cache"):b.disable("view cache"),b.enable("case sensitive routing"),b.enable("strict routing"),b.enable("trust proxy"),b.disable("x-powered-by"),b.use(cookie()),a.logger&&b.use(logger(a.logger)),a.vhost){var c=require("top-vhost");b.use(c(a.vhost))}if(a.timeout){var d=require("timeout-request");b.use(d(a.timeout))}if(b.use(csurf({cookie:{key:"token",httpOnly:!0}})),b.use(lusca({xframe:"SAMEORIGIN",xssProtection:!0})),b.use(compression({level:9,threshold:256})),a.signature){var e=require("server-signature");b.use(e(a.signature))}if(a.sitemap){var f=require("express-sitemap");f(a.sitemap).toFile()}http.globalAgent.maxSockets=Math.pow(a.fork,2),http.timeout=6e4;var g=Object.create(null),h=resolve(a.dir+"index.min.html");return b.get("/",function(a,b){b.sendFile(h)}),b.get("/:pkg/",function(b,c){var d=decodeURIComponent(b.params.pkg),e=b.headers.referer||b.headers.referrer;if("string"==typeof d&&a.referer.test(e)){if(a.cache&&g[d])return c.status(302).send(g[d].body),void(g[d].time=(new Date).getTime());var f=http.request({host:"registry.npmjs.org",port:80,path:"/"+d,method:"GET",headers:{"User-Agent":"supergiovane@"+VERSION}},function(b){var e=new Buffer(0);200===b.statusCode||304===b.statusCode?(b.on("data",function(a){e+=a}),b.on("end",function(){if(e=JSON.parse(e),e.readme=null,c.send(e),a.cache){var b,f=0,h=(new Date).getTime();for(var i in g)f++,g[i].time<h&&(b=i,h=g[b].time);f>=a.cache&&delete g[b],g[d]={body:e,time:(new Date).getTime()}}})):c.status(404).end(ERROR)});f.on("error",function(){c.status(404).end(ERROR)}),f.end()}else c.redirect(301,a.referer.source)}),b.use(function(a,b,c,d){var e=0;switch(DEBUG("error",{pid:process.pid,error:a}),a.message.toLowerCase()){case"not found":d();break;case"unauthorized":e=401;break;case"forbidden":e=403;break;default:e=500}c.status(e).end(ERROR)}),b.use(function(a,b){var c=404;b.status(c).end(ERROR)}),console.log(process.pid+" | listening on: "+a.host+":"+a.port),DEBUG("start",{pid:process.pid,host:a.host,port:a.port}),http.createServer(b).listen(a.port,a.host),b}try{var cluster=require("cluster"),compression=require("compression"),cookie=require("cookie-parser"),csurf=require("csurf"),express=require("express"),http=require("http"),lusca=require("lusca"),logger=require("logger-request"),resolve=require("path").resolve,cpu=2*require("os").cpus().length}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}var VERSION="1.3.0",ERROR="matusa",DEBUG=function(){};module.exports=function(a){var a=a||Object.create(null),b={env:String(a.env||"production"),host:String(a.host||"127.0.0.1"),port:Number(a.port)||3e3,referer:new RegExp(String(a.referer||"http://127.0.0.1"),"i"),dir:String(a.dir||__dirname+"/public/"),logger:0==a.logger?!1:a.logger||Object.create(null),timeout:0==a.timeout?!1:a.timeout||Object.create(null),sitemap:0==a.sitemap?!1:a.sitemap||Object.create(null),vhost:0==a.vhost?!1:a.vhost||!1,signature:0==a.signature?!1:a.signature||!1,cache:0==a.vhost?!1:Number(a.cache||5),fork:Number(a.fork||cpu),max:Number(a.max||0),debug:0==a.debug?!1:a.debug||"debug.log"};if(b.debug&&(DEBUG=logger({filename:b.debug,standalone:!0,winston:{logger:"supergiovane",level:"debug"}})),DEBUG("options",b),"development"==b.env)return bootstrap(b);if(!cluster.isMaster)return bootstrap(b);for(var c=0;c<b.fork;c++)cluster.fork();cluster.on("exit",function(a,c,d){console.error(a.process.pid+" died by "+d),DEBUG("restart",{max:b.max,code:c,signal:d}),(0/0===b.max||b.max-->0)&&cluster.fork()})};
