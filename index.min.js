/*
 * supergiovane v1.2.3
 * (c) hex7c0 http://supergiovane.tk
 * Licensed under GPLv3
 */
"use strict";function bootstrap(a){var b=express();b.set("env",a.env),"production"==a.env?b.enable("view cache"):b.disable("view cache"),b.enable("case sensitive routing"),b.enable("strict routing"),b.enable("trust proxy"),b.disable("x-powered-by"),b.disable("etag"),b.use(cookie()),a.logger&&b.use(logger(a.logger)),a.timeout&&b.use(timeout(a.timeout)),a.vhost&&b.use(vhost(a.vhost)),b.use(csurf({cookie:{key:"token",httpOnly:!0}})),b.use(lusca({xframe:"SAMEORIGIN",xssProtection:!0})),b.use(compression({level:9,threshold:256})),a.sitemap&&sitemap(a.sitemap).toFile(),http.globalAgent.maxSockets=Math.pow(cpu,2),http.timeout=6e4;var c=resolve(a.dir+"index.min.html");return b.get("/",function(a,b){b.sendFile(c)}),b.get("/:pkg/",function(b,c){var d=b.params.pkg,e=b.headers.referer||b.headers.referrer;if("string"==typeof d&&a.referer.test(e)){var f=http.request({host:"registry.npmjs.org",port:80,path:"/"+d,method:"GET",headers:{"User-Agent":"supergiovane@"+VERSION}},function(a){var b=new Buffer(0);200==a.statusCode||304==a.statusCode?(a.on("data",function(a){b+=a}),a.on("end",function(){b=b.toString(),b.readme=null,c.end(b)})):c.status(404).end(ERROR)});f.on("error",function(){c.status(404).end(ERROR)}),f.end()}else c.redirect(301,a.referer.source)}),b.use(function(a,b,c,d){var e=0;switch(a.message.toLowerCase()){case"not found":d();break;case"unauthorized":e=401;break;case"forbidden":e=403;break;case"bad gateway":e=502;break;default:e=500}c.status(e).end(ERROR)}),b.use(function(a,b){var c=404;b.status(c).end(ERROR)}),console.log(process.pid+" | listening on: "+a.host+":"+a.port),http.createServer(b).listen(a.port,a.host),b}try{var cluster=require("cluster"),compression=require("compression"),cookie=require("cookie-parser"),csurf=require("csurf"),express=require("express"),sitemap=require("express-sitemap"),http=require("http"),logger=require("logger-request"),lusca=require("lusca"),vhost=require("top-vhost"),timeout=require("timeout-request"),resolve=require("path").resolve,cpu=2*require("os").cpus().length}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}var VERSION="1.2.3",ERROR="matusa";module.exports=function(a){var a=a||Object.create(null),b={env:String(a.env||"production"),host:String(a.host||"127.0.0.1"),port:Number(a.port)||3e3,referer:new RegExp(String(a.referer||"http://127.0.0.1"),"i"),dir:String(a.dir||__dirname+"/public/"),logger:0==a.logger?!1:a.logger||Object.create(null),timeout:0==a.timeout?!1:a.timeout||Object.create(null),sitemap:0==a.sitemap?!1:a.sitemap||Object.create(null),vhost:0==a.vhost?!1:a.vhost||!1};if("development"==b.env)return bootstrap(b);if(!cluster.isMaster)return bootstrap(b);for(var c=0;cpu>c;c++)cluster.fork();cluster.on("exit",function(a,b,c){console.warn(a.process.pid+" died by "+c)})};
